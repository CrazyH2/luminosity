/*
 * Luminosity
 * A simple framework to create web apps
 *
 * @version 0.0.1
 * @author CrazyH2
 * @license Attribution-NonCommercial-NoDerivatives 4.0 International
 * @copyright 2025 CrazyH2
 */
const PURITY_KEYWORD="purity",DATA_PURITY_FLAG="data-purity_flag",init=t=>{const e=t;let i,n;function o(t,e){for(const{name:e}of t.attributes)t.removeAttribute(e);for(const{name:i,value:n}of e.node.attributes)t.setAttribute(i,n)}function s(){const t=i();console.warn("ðŸŒ€");for(const[e,i]of n){const n=t.get(e);if(n&&i.shallow.outerHTML!==n.shallow.outerHTML){const t=document.getElementById(e);if(!t)throw new Error(`There is no element in the DOM with id "${e}".`);o(t,n),i.shallow.innerHTML!==n.shallow.innerHTML?(t.innerHTML=n.node.innerHTML,console.warn(`\tâ†» #${e}`)):console.warn(`\tÂ± #${e}`)}}n=t}return{mount:function(t){i=()=>(t=>{const e=(new DOMParser).parseFromString(t,"text/html"),i=new Map;for(const t of e.querySelectorAll("[id]")){const e=t.cloneNode(!0);for(const t of e.querySelectorAll("[id]"))t.outerHTML=`\x3c!-- ${t.tagName}#${t.id} --\x3e`;for(const t of e.querySelectorAll(`[${DATA_PURITY_FLAG}]`))for(const e in t.dataset)e.startsWith("purity")&&t.removeAttribute(`data-${e}`);i.set(t.id,{node:t,shallow:e})}return i})(t()),n=i();const e=n.keys().next().value,o=document.getElementById(e),s=n.get(e)?.node;if(!o||!s)throw new Error(`Root DOM element's id does not correspond to the defined application root id "${e}".`);o.replaceWith(s)},rerender:s,getState:()=>e,setState(t){Object.assign(e,t(e)),s()}}},ARGS_RE=/__\[(\d+)\]__/gm,BOUND_EVENTS_RE=/::(\w+)\s*=\s*__\[(\d+)\]__/gm;export const isTruthy=t=>null!=t&&!1!==t;const clearFalsy=t=>isTruthy(t)?t:"",joinIfArray=t=>Array.isArray(t)?t.join(""):t,applyPurityKey=(()=>{let t,e=0;return()=>(t&&clearTimeout(t),t=setTimeout((()=>{e=0})),e++)})(),render=([t,...e],...i)=>e.reduce(((t,e,i)=>`${t}__[${i}]__${e}`),t).replace(BOUND_EVENTS_RE,((t,e,n)=>{const o=`data-purity_${e}_${applyPurityKey()}`;return setTimeout((()=>{const t=document.querySelector(`[${o}]`),s=i[n];t&&"function"==typeof s&&(t[`on${e}`]=s,t.removeAttribute(o))})),`${o} ${DATA_PURITY_FLAG}`})).replace(ARGS_RE,((t,e)=>{return joinIfArray((n=i[+e],isTruthy(n)?n:""));var n})).trim().replace(/\n\s*</g,"<").replace(/>\n\s*/g,">");class LuminosityRouter{constructor(){this.routes={},this.currentRoute=null,window.addEventListener("hashchange",this.handleLocation.bind(this))}handleLocation(t){let e=window.location.hash;if(!e)return"/";const i=e.substring(1).startsWith("/")?e.substring(2):e.substring(1);var n=this.routes[i];n||(n=this.routes[404]),this.currentRoute=n,console.log(n),luminosity.renderPage(n)}addRoute(t,e){this.routes[t]=e}}class Luminosity{constructor(){this.path=window.LuminosityPath||"/luminosity/",this.version="0.0.1",this.pages={},this.states={},this.setState=()=>{},this.getState=()=>{},this.config={},this.loading_page=null,this.start_page=null,this.error_page=null,this.not_found_page=null,this.global_css={},this.init_with_states={},this.current_page=null,this.mount=null,this.router=new LuminosityRouter,console.info(`Luminosity v${this.version} initialized`),this.init()}async init(){await this.loadConfig();var t=this.checkConfig();if(!0!==t)return t;const{mount:e,getState:i,setState:n}=init(this.states);this.mount=e,this.getState=i,this.setState=n,this.setMetadata(),await this.loadLoadingPage(),this.renderPage(this.loading_page),await this.loadStartPage(),await this.loadErrorPage(),await this.loadNotFoundPage(),await this.loadPages(),this.loadGlobalCss(),this.onEvents(),this.router.handleLocation({}),this.start()}async loadConfig(){try{const t=await fetch(`${this.path}config.json`);this.config=await t.json()}catch(t){console.error("Luminosuty: Error fetching config:",t)}}checkConfig(){return this.config.main?this.config.main.title?this.config.main.description?this.config.main.favicon?this.config.main.author?this.config.main.start_page?this.config.main.loading_page?this.config.main.not_found_page?this.config.main.on_error?this.config.main.on_error.page?this.config.main.on_error.info_element?(this.config.main.global_css||(this.config.main.global_css={}),this.global_css=this.config.main.global_css,this.config.main.init_with_states||(this.config.main.init_with_states={}),this.init_with_states=this.config.main.init_with_states,this.config.pages?(this.loading_page||(this.loading_page=this.config.main.loading_page),this.start_page||(this.start_page=this.config.main.start_page),this.error_page||(this.error_page=this.config.main.on_error.page),console.log("Luminosity: Config loaded"),!0):console.error("Luminosity: Missing pages in config")):console.error("Luminosity: Missing info_element in on_error"):console.error("Luminosity: Missing page in on_error"):console.error("Luminosity: Missing on_error in config"):console.error("Luminosity: Missing not_found_page in config"):console.error("Luminosity: Missing loading_page in config"):console.error("Luminosity: Missing start_page in config"):console.error("Luminosity: Missing author in config"):console.error("Luminosity: Missing favicon in config"):console.error("Luminosity: Missing description in config"):console.error("Luminosity: Missing title in config"):console.error("Luminosity: Missing main in config")}setMetadata(){document.title=this.config.main.title;let t=document.querySelector('meta[name="author"]');t||(t=document.createElement("meta"),t.setAttribute("name","author"),document.head.appendChild(t)),t.setAttribute("content",this.config.main.author);let e=document.querySelector('meta[name="description"]');e||(e=document.createElement("meta"),e.setAttribute("name","description"),document.head.appendChild(e)),e.setAttribute("content",this.config.main.description);let i=document.querySelector('link[rel="icon"]');i||(i=document.createElement("link"),i.setAttribute("rel","icon"),document.head.appendChild(i)),i.setAttribute("href",this.config.main.favicon),console.log("Luminosity: Metadata set")}async loadPage(t,e=!1){try{const i=(await import(`${this.path}templates/${t}`)).default;if(!i)return console.error(`Luminosity: Missing default export in ${t}`);if(!i.getTitle&&0==e)return console.error(`Luminosity: Missing getTitle function in ${t}`);if(!i.init)return console.error(`Luminosity: Missing init function in ${t}`);if(!i.style)return console.error(`Luminosity: Missing style function in ${t}`);if(!i.render)return console.error(`Luminosity: Missing render function in ${t}`);if(!i.onEvent)return console.error(`Luminosity: Missing onEvent function in ${t}`);i.init(this.setState,this.getState,this.stateUpdate);const n=t.split(".").slice(0,-1).join(".");return this.router.addRoute(n,i),i}catch(t){console.error("Luminosity: Error fetching page:",t)}}async loadComponent(t){try{const e=(await import(`${this.path}components/${t}`)).default;return e?"function"==typeof e?await e(this.setState,this.getState,this.stateUpdate):e:console.error(`Luminosity: Missing default export in ${t}`)}catch(t){console.error("Luminosity: Error fetching component:",t)}}async loadPages(){for(const t in this.config.pages)this.pages[t]=await this.loadPage(this.config.pages[t]);console.log("Luminosity: Pages loaded")}async loadLoadingPage(){this.loading_page=await this.loadPage(this.config.main.loading_page)}async loadStartPage(){this.start_page=await this.loadPage(this.config.main.start_page)}async loadErrorPage(){this.error_page=await this.loadPage(this.config.main.on_error.page)}async loadNotFoundPage(){this.not_found_page=await this.loadPage(this.config.main.not_found_page),this.router.addRoute("404",(()=>luminosity.renderPage(this.not_found_page)))}loadGlobalCss(){for(const[t,e]of Object.entries(this.global_css))document.documentElement.style.setProperty(t,e)}stateUpdate(){this.renderPage(this.current_page)}_renderPage(t){if(!this.pages[t]&&this.start_page!==t&&this.loading_page!==t&&this.error_page!==t)return console.error("Luminosity: Page not found");try{this.current_page=t;const n=t.style(this.setState,this.getState,this.stateUpdate),o=t.render(render,this.setState,this.getState,this.stateUpdate,this.loadComponent);var e=document.getElementById("luminosity-style");e?e.innerHTML=n:((e=document.createElement("style")).id="luminosity-style",document.head.appendChild(e));var i=t.getTitle(luminosity.setState,luminosity.getState,luminosity.stateUpdate);return i&&(document.title=i),console.log("Luminosity: Page rendered"),o}catch(t){return console.error("Luminosity: Error rendering page:",t),render`<div id="root"><a>Error rendering page</a></div>`}}renderPage(t){const e=this;e.mount((()=>e._renderPage(t)))}async start(){var t=console.error,e=this.onError;console.error=function(){return e(arguments),t.apply(console,arguments)},window.addEventListener("error",(t=>{this.onError(t.message)})),this.renderPage(this.start_page),console.log("Luminosity: Started")}onEvent(t,e){this.current_page.onEvent(t,e,this.setState,this.getState,this.stateUpdate)}onEvents(){document.addEventListener("click",(t=>this.onEvent("click",t))),document.addEventListener("keydown",(t=>this.onEvent("keydown",t))),document.addEventListener("keyup",(t=>this.onEvent("keyup",t))),document.addEventListener("mousemove",(t=>this.onEvent("mousemove",t))),document.addEventListener("mouseover",(t=>this.onEvent("mouseover",t))),document.addEventListener("mouseout",(t=>this.onEvent("mouseout",t))),document.addEventListener("dblclick",(t=>this.onEvent("dblclick",t))),document.addEventListener("contextmenu",(t=>this.onEvent("contextmenu",t))),document.addEventListener("resize",(t=>this.onEvent("resize",t))),document.addEventListener("scroll",(t=>this.onEvent("scroll",t))),document.addEventListener("focus",(t=>this.onEvent("focus",t))),document.addEventListener("blur",(t=>this.onEvent("blur",t)))}async onError(t){await luminosity.renderPage(luminosity.error_page),await new Promise((t=>setTimeout(t,100))),luminosity.setState((({error:e})=>({error:t})))}}window.luminosity=new Luminosity;
